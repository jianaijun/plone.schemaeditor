<html xmlns="http://www.w3.org/1999/xhtml" xml:lang="en"
>

<head tal:define="portal_url context/@@plone_portal_state/portal_url">
<style type="text/css" media="screen">
    body {
        font: 100% Arial,FreeSans,sans-serif;
    }
    #modelEditor {
        position: absolute;
        top: 100px;
        right: 0;
        bottom: 2%;
        left: 0;
        border: 1px solid black;
    }
    .formControls {
        text-align: right;
        font-size: 175%;
    }
    .formControls input {
        font-size: 100%;
    }
    .portalMessage {
        float: left;
        font-size: 200%;
        color: #fff;
    }
    .portalMessage span {
        background-color: #0a0;
        padding: 0.5em;
    }
</style>


<script src="++resource++plone.app.jquery.js"
    type="text/javascript"
    tal:attributes="src string:${portal_url}/++resource++plone.app.jquery.js"
    ></script>
<script src="++resource++plone.resourceeditor/ace/ace.js"
    type="text/javascript"
    charset="utf-8"
    tal:attributes="src string:${portal_url}/++resource++plone.resourceeditor/ace/ace.js"
    ></script>

<script type="text/javascript">
    jQuery(function ($) {
        var editor = ace.edit("modelEditor"),
            session = editor.getSession(),
            myform = $("#saveform");

        // editor tuneup
        editor.setTheme("ace/theme/textmate");
        session.setMode("ace/mode/xml");
        session.setTabSize(4);
        session.setUseSoftTabs(true);
        session.setUseWrapMode(true);
        editor.setHighlightActiveLine(false);
        // Make save keystroke trigger save form submit
        editor.commands.addCommand({
            name: "save",
            bindKey: {win: "Ctrl-S", mac: "Command-S"},
            exec: function() {
                myform.submit();
            }
        });

        // enable save submit button on change
        session.on('change', function(e) {
            $('#saveform :submit').removeAttr('disabled');
        });

        // form submit handler; ajax posts data
        myform.on( "submit", function( event ) {
            var action = myform.attr('action');

            // prevent real submit
            event.preventDefault();

            // stuff the editor contents into the form
            // for easy serialization
            $('#savesource').val(editor.getValue());

            $.getJSON(action, myform.serialize(), function (rez) {
                if (rez.success) {
                    var messagespan = $("#messagespan");

                    // disable save button
                    $('#saveform :submit').attr('disabled', 'disabled');
                    messagespan.html(rez.message);
                    messagespan.show().fadeOut(1000);


                } else {
                    alert(rez.message);
                }
            })
            .fail(function() { alert("No response from server; not saved."); });

        });
    });
</script>


</head>

<body>
<div  class="documentEditable" >

    <div class="portalMessage info">
      <span id="messagespan" style="display:none">
        &nbsp;
      </span>&nbsp;
    </div>

    <form id="saveform"
        tal:attributes="action string:${context/absolute_url}/@@model-edit-save"
        tal:define="authenticator context/@@authenticator/authenticator | nothing">
        <input tal:replace="structure authenticator" />
        <input type="hidden" id="savesource" name="source" value="" />
        <div class="formControls">
            <input class="context" type="submit" name="form.button.save" value="Save" disabled="disabled" />
        </div>

    </form>

    <div id="content">
        <div id="modelEditor" tal:content="view/modelSource" />
    </div>

</div>


<script type="text/javascript">
</script>

</body>
</html>
